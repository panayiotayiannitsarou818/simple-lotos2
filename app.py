#!/usr/bin/env python3
"""
Streamlit ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î³Î¹Î± ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ Î¼Î±Î¸Î·Ï„ÏÎ½ Î‘' Î”Î·Î¼Î¿Ï„Î¹ÎºÎ¿Ï.
"""

import streamlit as st
import pandas as pd
from utils.statistics_generator import generate_statistics_table, export_statistics_to_excel
from utils.data_validator import validate_excel_structure


def main():
    """ÎšÏÏÎ¹Î± function Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚."""
    st.set_page_config(
        page_title="Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ ÎœÎ±Î¸Î·Ï„ÏÎ½ Î‘' Î”Î·Î¼Î¿Ï„Î¹ÎºÎ¿Ï", 
        page_icon="ğŸ“Š",
        layout="wide"
    )
    
    st.title("ğŸ“Š Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ ÎœÎ±Î¸Î·Ï„ÏÎ½ Î‘' Î”Î·Î¼Î¿Ï„Î¹ÎºÎ¿Ï")
    
    # Copyright notice
    st.sidebar.markdown("""
    **Â© 2024 - Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ ÎœÎ±Î¸Î·Ï„ÏÎ½**  
    Î Î½ÎµÏ…Î¼Î±Ï„Î¹ÎºÎ¬ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î´Î¹Î±Ï„Î·ÏÎ¿ÏÎ½Ï„Î±Î¹.
    """)
    
    # Terms acceptance check
    if "terms_accepted" not in st.session_state:
        st.session_state.terms_accepted = False
    
    if not st.session_state.terms_accepted:
        show_terms_page()
        return
    
    # Application control
    if st.sidebar.button("ğŸ”„ Î•Ï€Î±Î½ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·", type="secondary"):
        reset_application()
        st.rerun()
    
    # Main application flow
    st.markdown("---")
    
    # Step 1: File Upload
    st.header("ğŸ“ Î’Î®Î¼Î± 1: Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Excel")
    uploaded_file = st.file_uploader(
        "Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Excel Î¼Îµ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¼Î±Î¸Î·Ï„ÏÎ½:",
        type=["xlsx", "xls"],
        help="Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Ï„Î¹Ï‚ Î±Ï€Î±Î¹Ï„Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ ÏƒÏ„Î®Î»ÎµÏ‚"
    )
    
    if uploaded_file is not None:
        try:
            df = pd.read_excel(uploaded_file)
            
            # Validate structure
            is_valid, errors = validate_excel_structure(df)
            
            if not is_valid:
                st.error("âŒ Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Î´Î¿Î¼Î® Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï…:")
                for error in errors:
                    st.error(f"â€¢ {error}")
                return
            
            st.success("âœ… Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!")
            
            # Show data preview
            with st.expander("ğŸ‘€ Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½"):
                st.dataframe(df.head(10))
                st.info(f"Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ Î¼Î±Î¸Î·Ï„Î­Ï‚: {len(df)} | Î¤Î¼Î®Î¼Î±Ï„Î±: {df['Î¤ÎœÎ—ÎœÎ‘'].nunique()}")
            
            # Step 2: Generate Statistics
            st.header("ğŸ“Š Î’Î®Î¼Î± 2: Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½")
            
            if st.button("ğŸ“ˆ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î Î¯Î½Î±ÎºÎ± Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½", type="primary"):
                with st.spinner("Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½..."):
                    stats_df = generate_statistics_table(df)
                
                st.success("âœ… ÎŸ Ï€Î¯Î½Î±ÎºÎ±Ï‚ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ!")
                
                # Display statistics
                st.subheader("ğŸ“‹ Î Î¯Î½Î±ÎºÎ±Ï‚ Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½")
                st.dataframe(stats_df, use_container_width=True)
                
                # Step 3: Export
                st.header("ğŸ’¾ Î’Î®Î¼Î± 3: Î•Î¾Î±Î³Ï‰Î³Î® Î Î¯Î½Î±ÎºÎ±")
                
                excel_buffer = export_statistics_to_excel(stats_df)
                
                st.download_button(
                    label="ğŸ“¥ ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± Excel Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½",
                    data=excel_buffer.getvalue(),
                    file_name="statistika_mathiton.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    type="primary"
                )
                
        except Exception as e:
            st.error(f"âŒ Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±: {str(e)}")
    
    # Show required columns info
    with st.sidebar:
        st.header("ğŸ“‹ Î‘Ï€Î±Î¹Ï„Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ Î£Ï„Î®Î»ÎµÏ‚ Excel")
        required_cols = [
            "ÎŸÎÎŸÎœÎ‘", "Î¦Î¥Î›ÎŸ", "Î Î‘Î™Î”Î™_Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥",
            "Î–Î©Î—Î¡ÎŸÎ£", "Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘", "ÎšÎ‘Î›Î—_Î“ÎÎ©Î£Î—_Î•Î›Î›Î—ÎÎ™ÎšÎ©Î", 
            "Î¦Î™Î›ÎŸÎ™", "Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—", "Î¤ÎœÎ—ÎœÎ‘"
        ]
        for col in required_cols:
            st.text(f"â€¢ {col}")
    
    # Show sample data link
    with st.sidebar:
        st.markdown("---")
        st.header("ğŸ“‹ Sample Data")
        st.markdown("""
        **Î“Î¹Î± Î´Î¿ÎºÎ¹Î¼Î® Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚:**
        
        ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î± Î´ÎµÎ¯Î³Î¼Î± Excel Î¼Îµ Ï„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Î´ÎµÎ´Î¿Î¼Î­Î½Î±:
        
        | ÎŸÎÎŸÎœÎ‘ | Î¦Î¥Î›ÎŸ | Î Î‘Î™Î”Î™_Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥ | Î–Î©Î—Î¡ÎŸÎ£ | Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘ | ÎšÎ‘Î›Î—_Î“ÎÎ©Î£Î—_Î•Î›Î›Î—ÎÎ™ÎšÎ©Î | Î¦Î™Î›ÎŸÎ™ | Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î— | Î¤ÎœÎ—ÎœÎ‘ |
        |-------|------|-------------------|--------|---------------|-------------------|-------|-----------|-------|
        | Î†Î½Î½Î± | Îš | Î | Î | ÎŸ | Î | | | Î‘1 |
        | Î“Î¹Î¬Î½Î½Î·Ï‚ | Î‘ | ÎŸ | Î | Î | Î | | | Î‘1 |
        | ÎœÎ±ÏÎ¯Î± | Îš | Î | ÎŸ | ÎŸ | Î | | | Î‘2 |
        | Î Î­Ï„ÏÎ¿Ï‚ | Î‘ | ÎŸ | Î | ÎŸ | ÎŸ | | | Î‘2 |
        """)
    
    # Additional info
    with st.sidebar:
        st.markdown("---")
        st.header("â„¹ï¸ Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚")
        st.markdown("""
        **ÎˆÎºÎ´Î¿ÏƒÎ·:** 1.0.0  
        **Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·:** Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚ 2024  
        **Î£Ï…Î¼Î²Î±Ï„ÏŒÏ„Î·Ï„Î±:** Excel 2016+  
        
        **Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·:**  
        Î“Î¹Î± ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚ Î® Ï€ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î±, ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î®ÏƒÏ„Îµ Î¼Îµ Ï„Î¿Î½ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®.
        """)


def show_terms_page():
    """Î•Î¼Ï†Î±Î½Î¯Î¶ÎµÎ¹ Ï„Î· ÏƒÎµÎ»Î¯Î´Î± Î±Ï€Î¿Î´Î¿Ï‡Î®Ï‚ ÏŒÏÏ‰Î½ Ï‡ÏÎ®ÏƒÎ·Ï‚."""
    st.header("ğŸ“‹ ÎŒÏÎ¿Î¹ Î§ÏÎ®ÏƒÎ·Ï‚")
    
    st.markdown("""
    **ÎŒÏÎ¿Î¹ ÎºÎ±Î¹ Î ÏÎ¿Ï‹Ï€Î¿Î¸Î­ÏƒÎµÎ¹Ï‚ Î§ÏÎ®ÏƒÎ·Ï‚**
    
    ÎœÎµ Ï„Î· Ï‡ÏÎ®ÏƒÎ· Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ ÏƒÏ…Î¼Ï†Ï‰Î½ÎµÎ¯Ï„Îµ Î¼Îµ Ï„Î± Î±ÎºÏŒÎ»Î¿Ï…Î¸Î±:
    
    1. **Î•Î¼Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±**: Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¼Î±Î¸Î·Ï„ÏÎ½ ÎµÎ¯Î½Î±Î¹ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„Î± ÎºÎ±Î¹ Î¸Î± Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î¿ÏÎ½ Î¼Îµ Î±Ï€ÏŒÎ»Ï…Ï„Î· ÎµÎ¼Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±.
    
    2. **Î ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î± Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½**: Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î´ÎµÎ½ Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¼ÏŒÎ½Î¹Î¼Î±. ÎŒÎ»Î± Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î´Î¹Î±Î³ÏÎ¬Ï†Î¿Î½Ï„Î±Î¹ Î¼ÎµÏ„Î¬ Ï„Î· Ï‡ÏÎ®ÏƒÎ·.
    
    3. **ÎÏŒÎ¼Î¹Î¼Î· Î§ÏÎ®ÏƒÎ·**: Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï€ÏÎ¿Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚ ÏƒÎºÎ¿Ï€Î¿ÏÏ‚.
    
    4. **Î Î½ÎµÏ…Î¼Î±Ï„Î¹ÎºÎ¬ Î”Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î±**: Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï€Î½ÎµÏ…Î¼Î±Ï„Î¹ÎºÎ¬ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î±.
    
    5. **Î•Ï…Î¸ÏÎ½Î· Î§ÏÎ®ÏƒÏ„Î·**: ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ ÎµÎ¯Î½Î±Î¹ Ï…Ï€ÎµÏÎ¸Ï…Î½Î¿Ï‚ Î³Î¹Î± Ï„Î·Î½ Î±ÎºÏÎ¯Î²ÎµÎ¹Î± Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Ï€Î¿Ï… ÎµÎ¹ÏƒÎ¬Î³ÎµÎ¹.
    
    6. **Î¤ÎµÏ‡Î½Î¹ÎºÎ® Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·**: Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï€Î±ÏÎ­Ï‡ÎµÏ„Î±Î¹ "Ï‰Ï‚ Î­Ï‡ÎµÎ¹" Ï‡Ï‰ÏÎ¯Ï‚ ÎµÎ³Î³Ï…Î®ÏƒÎµÎ¹Ï‚.
    """)
    
    st.markdown("---")
    
    # Warning box
    st.warning("""
    âš ï¸ **Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ® Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ·:**
    
    Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¼Î±Î¸Î·Ï„ÏÎ½ Ï€ÎµÏÎ¹Î­Ï‡Î¿Ï…Î½ Ï€ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÎ­Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚. Î’ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹:
    - ÎˆÏ‡ÎµÏ„Îµ Ï„Î· ÏƒÏ‡ÎµÏ„Î¹ÎºÎ® Î¬Î´ÎµÎ¹Î± Î³Î¹Î± Ï‡ÏÎ®ÏƒÎ· Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
    - Î£Ï…Î¼Î¼Î¿ÏÏ†ÏÎ½ÎµÏƒÏ„Îµ Î¼Îµ Ï„Î¿ GDPR ÎºÎ±Î¹ Ï„Î¿Ï…Ï‚ Ï„Î¿Ï€Î¹ÎºÎ¿ÏÏ‚ Î½ÏŒÎ¼Î¿Ï…Ï‚
    - Î”ÎµÎ½ Î¼Î¿Î¹ÏÎ¬Î¶ÎµÏƒÏ„Îµ Ï„Î± Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± Ï‡Ï‰ÏÎ¯Ï‚ Î¬Î´ÎµÎ¹Î±
    """)
    
    st.markdown("---")
    
    # Acceptance buttons
    col1, col2, col3 = st.columns([1, 1, 1])
    
    with col1:
        if st.button("âœ… Î‘Ï€Î¿Î´Î­Ï‡Î¿Î¼Î±Î¹ Ï„Î¿Ï…Ï‚ ÎŒÏÎ¿Ï…Ï‚", type="primary", use_container_width=True):
            st.session_state.terms_accepted = True
            st.success("ÎŒÏÎ¿Î¹ ÎµÎ³ÎºÏÎ¯Î¸Î·ÎºÎ±Î½! Î‘Î½Î±ÎºÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·...")
            st.rerun()
    
    with col2:
        if st.button("ğŸ“– Î”Î¹Î±Î²Î¬Î¶Ï‰ Î¾Î±Î½Î¬", type="secondary", use_container_width=True):
            st.rerun()
    
    with col3:
        if st.button("âŒ Î”ÎµÎ½ Î‘Ï€Î¿Î´Î­Ï‡Î¿Î¼Î±Î¹", type="secondary", use_container_width=True):
            st.error("Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï‡Ï‰ÏÎ¯Ï‚ Î±Ï€Î¿Î´Î¿Ï‡Î® Ï„Ï‰Î½ ÏŒÏÏ‰Î½.")
            st.stop()


def reset_application():
    """Î•Ï€Î±Î½ÎµÎºÎºÎ¯Î½Î·ÏƒÎ· Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚."""
    for key in list(st.session_state.keys()):
        if key != "terms_accepted":
            del st.session_state[key]


if __name__ == "__main__":
    main()
